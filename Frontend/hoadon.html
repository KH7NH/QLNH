<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Danh s√°ch h√≥a ƒë∆°n (Qu·∫£n l√Ω & B·∫øp)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    .badge { font-size: 0.85rem; padding: 4px 8px; border-radius: 999px; }
    .table-hover tbody tr { cursor: pointer; }
    .detail-items-wrapper { max-height: 300px; overflow-y: auto; }
  </style>
</head>

<body class="py-4">

  <div class="bg-danger text-white mb-3">
    <div class="container d-flex justify-content-between align-items-center py-1">
      <div>
        <i class="bi bi-egg-fried me-1"></i> H·ªá th·ªëng h√≥a ƒë∆°n - Khu√™Food
      </div>
      <div class="d-flex align-items-center gap-2">
        <span id="authInfo" class="small"></span>
        <button id="logoutBtn" class="btn btn-sm btn-light">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div id="alertBox"></div>

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0 text-danger">üìÑ DANH S√ÅCH H√ìA ƒê∆†N</h2>

      <select id="statusFilter" class="form-select form-select-sm" style="width:180px">
        <option value="">T·∫•t c·∫£</option>
        <option value="Ch·ªù x·ª≠ l√Ω">Ch·ªù x·ª≠ l√Ω</option>
        <option value="ƒêang l√†m">ƒêang l√†m</option>
        <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
        <option value="ƒê√£ h·ªßy">ƒê√£ h·ªßy</option>
      </select>
    </div>

    <table class="table table-hover align-middle" id="ordersTable">
      <thead class="table-danger">
        <tr>
          <th>ID</th>
          <th>Kh√°ch</th>
          <th>Th·ªùi gian</th>
          <th>Tr·∫°ng th√°i</th>
          <th class="text-end">T·ªïng</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Modal chi ti·∫øt -->
  <div class="modal fade" id="orderDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">Chi ti·∫øt ƒë∆°n <span id="detailIDDH"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div><strong>Kh√°ch:</strong> <span id="detailTenKhach"></span></div>
          <div><strong>Th·ªùi gian:</strong> <span id="detailThoiGian"></span></div>

          <div class="mt-2"><strong>Ghi ch√∫:</strong></div>
          <p id="detailGhiChu" class="text-muted mb-2"></p>

          <div class="d-flex justify-content-between align-items-center mb-2">
            <select id="detailTrangThai" class="form-select form-select-sm" style="width:180px">
              <option>Ch·ªù x·ª≠ l√Ω</option>
              <option>ƒêang l√†m</option>
              <option>Ho√†n th√†nh</option>
              <option>ƒê√£ h·ªßy</option>
            </select>

            <button id="btnUpdateStatus" class="btn btn-success btn-sm">
              L∆∞u tr·∫°ng th√°i
            </button>
          </div>

          <div class="detail-items-wrapper">
            <table class="table table-sm table-bordered">
              <thead>
                <tr>
                  <th>M√≥n</th>
                  <th class="text-end">SL</th>
                  <th class="text-end">ƒê∆°n gi√°</th>
                  <th class="text-end">Th√†nh ti·ªÅn</th>
                </tr>
              </thead>
              <tbody id="detailItemsBody"></tbody>
            </table>
          </div>

          <div class="text-end mt-2">
            <strong>T·ªïng:</strong> <span id="detailTongTien"></span>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* =====================
       AUTH + ROLE
       ===================== */

    function normalizeRole(s) {
      return (s || "")
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, "");
    }

    function getUser() {
      try { return JSON.parse(localStorage.getItem("user") || "null"); }
      catch { return null; }
    }

    function getToken() {
      return localStorage.getItem("token");
    }

    function authHeaders() {
      const token = getToken();
      return token ? { Authorization: `Bearer ${token}` } : {};
    }

    function showAlert(msg, type = "success") {
      document.getElementById("alertBox").innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${msg}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
    }

    function requireRoles(roles) {
      const user = getUser();
      const token = getToken();

      if (!user || !token) {
        window.location.href = "gdlogin.html";
        return false;
      }

      const ok = roles.map(normalizeRole).includes(normalizeRole(user.VaiTro));
      if (!ok) {
        alert("Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p");
        window.location.href = "gdtrangchu.html";
        return false;
      }

      return true;
    }

    // Cho ph√©p v√†o trang: Qu·∫£n l√Ω / B·∫øp / Nh√¢n vi√™n (t√πy b·∫°n)
    requireRoles(["Qu·∫£n l√Ω", "Nh√¢n vi√™n", "B·∫øp"]);

    // show info
    (function fillAuthInfo() {
      const u = getUser();
      const el = document.getElementById("authInfo");
      if (u && el) el.textContent = `Xin ch√†o: ${u.TenNV || u.Username || ""} (${u.VaiTro || ""})`;
    })();

    document.getElementById("logoutBtn").onclick = () => {
      localStorage.clear();
      window.location.href = "gdlogin.html";
    };
  </script>

  <script>
    /* =====================
       ORDER LOGIC
       ===================== */

    const API_ORDERS = "http://localhost:3000/api/order";
    let currentOrderId = null;
    let currentRole = normalizeRole(getUser()?.VaiTro);

    // element refs (fix modal not opening / undefined)
    const orderDetailModalEl = document.getElementById("orderDetailModal");
    const detailIDDH = document.getElementById("detailIDDH");
    const detailTenKhach = document.getElementById("detailTenKhach");
    const detailThoiGian = document.getElementById("detailThoiGian");
    const detailGhiChu = document.getElementById("detailGhiChu");
    const detailTrangThai = document.getElementById("detailTrangThai");
    const detailItemsBody = document.getElementById("detailItemsBody");
    const detailTongTien = document.getElementById("detailTongTien");
    const btnUpdateStatus = document.getElementById("btnUpdateStatus");

    function pick(obj, keys, fallback = null) {
      for (const k of keys) if (obj && obj[k] !== undefined && obj[k] !== null) return obj[k];
      return fallback;
    }

    function formatMoney(v) {
      const n = Number(v);
      if (!Number.isFinite(n)) return "0ƒë";
      return n.toLocaleString("vi-VN") + "ƒë";
    }

    function formatDate(v) {
      if (!v) return "";
      const d = new Date(v);
      if (isNaN(d.getTime())) return "";
      return d.toLocaleString("vi-VN");
    }

    function normalizeOrderRow(o) {
      // theo backend c·ªßa b·∫°n: IDDH, TenKhachHang, ThoiGian, TrangThai, TongTien
      const id = pick(o, ["IDDH", "IDDonHang", "id", "_id"], "");
      const tenKhach = pick(o, ["TenKhachHang"], "");
      const ngay = pick(o, ["ThoiGian", "Ngay", "createdAt"], null);
      const trangThai = pick(o, ["TrangThai"], "");
      const tong = pick(o, ["TongTien"], 0);
      return { id, tenKhach, ngay, trangThai, tong, raw: o };
    }

    async function loadOrders() {
      try {
        const res = await fetch(API_ORDERS, { headers: authHeaders() });

        if (!res.ok) {
          if (res.status === 401) return showAlert("Token h·∫øt h·∫°n / ch∆∞a ƒëƒÉng nh·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!", "warning");
          if (res.status === 403) return showAlert("B·∫°n kh√¥ng c√≥ quy·ªÅn xem h√≥a ƒë∆°n!", "danger");

          const text = await res.text().catch(() => "");
          console.error("Load orders error:", res.status, text);
          return showAlert("Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch h√≥a ƒë∆°n!", "danger");
        }

        const data = await res.json();
        renderOrders(Array.isArray(data) ? data : []);
      } catch (err) {
        console.error(err);
        showAlert("Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch h√≥a ƒë∆°n!", "danger");
      }
    }

    function renderOrders(list) {
      const tbody = document.querySelector("#ordersTable tbody");
      tbody.innerHTML = "";

      const filterVal = (document.getElementById("statusFilter")?.value || "").trim();
      const rows = list.map(normalizeOrderRow).filter(r => !filterVal || r.trangThai === filterVal);

      if (rows.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="5" class="text-center text-muted py-4">Kh√¥ng c√≥ h√≥a ƒë∆°n ph√π h·ª£p.</td>`;
        tbody.appendChild(tr);
        return;
      }

      rows.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.id || ""}</td>
          <td>${r.tenKhach || ""}</td>
          <td>${formatDate(r.ngay) || ""}</td>
          <td>${r.trangThai || ""}</td>
          <td class="text-end">${formatMoney(r.tong)}</td>
        `;
        tr.onclick = () => openOrderDetail(r.id);
        tbody.appendChild(tr);
      });
    }

    async function openOrderDetail(id) {
      currentOrderId = id;

      try {
        const res = await fetch(`${API_ORDERS}/${id}`, { headers: authHeaders() });

        if (!res.ok) {
          if (res.status === 401) return showAlert("Token h·∫øt h·∫°n / ch∆∞a ƒëƒÉng nh·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!", "warning");
          if (res.status === 403) return showAlert("B·∫°n kh√¥ng c√≥ quy·ªÅn xem chi ti·∫øt h√≥a ƒë∆°n!", "danger");

          const text = await res.text().catch(() => "");
          console.error("Order detail error:", res.status, text);
          return showAlert("Kh√¥ng t·∫£i ƒë∆∞·ª£c chi ti·∫øt h√≥a ƒë∆°n!", "danger");
        }

        const o = await res.json();

        // theo backend: IDDH, TenKhachHang, ThoiGian, TrangThai, GhiChu, ChiTiet[], TongTien
        const detailId = pick(o, ["IDDH", "IDDonHang", "id", "_id"], id);
        const tenKhach = pick(o, ["TenKhachHang"], "");
        const ngay = pick(o, ["ThoiGian", "Ngay", "createdAt"], null);
        const trangThai = pick(o, ["TrangThai"], "Ch·ªù x·ª≠ l√Ω");
        const tong = pick(o, ["TongTien"], 0);
        const ghiChu = pick(o, ["GhiChu"], "");

        const items = pick(o, ["ChiTiet"], []);
        const safeItems = Array.isArray(items) ? items : [];

        detailIDDH.textContent = "#" + (detailId ?? id ?? "");
        detailTenKhach.textContent = tenKhach || "";
        detailThoiGian.textContent = formatDate(ngay) || "";
        detailGhiChu.textContent = ghiChu || "";
        detailTrangThai.value = trangThai || "Ch·ªù x·ª≠ l√Ω";
        detailTongTien.textContent = formatMoney(tong);

        detailItemsBody.innerHTML = "";
        safeItems.forEach(i => {
          const tenMon = pick(i, ["TenMon"], "");
          const soLuong = Number(pick(i, ["SoLuong"], 0)) || 0;
          const donGia = Number(pick(i, ["DonGia"], 0)) || 0;
          const thanhTien = soLuong * donGia;

          detailItemsBody.innerHTML += `
            <tr>
              <td>${tenMon}</td>
              <td class="text-end">${soLuong}</td>
              <td class="text-end">${donGia.toLocaleString("vi-VN")}</td>
              <td class="text-end">${thanhTien.toLocaleString("vi-VN")}</td>
            </tr>`;
        });

        // ‚úÖ ph√¢n quy·ªÅn UI: B·∫øp + Qu·∫£n l√Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t
        const canUpdateStatus = ["bep", "quanly"].includes(currentRole);
        btnUpdateStatus.style.display = canUpdateStatus ? "" : "none";
        detailTrangThai.disabled = !canUpdateStatus;

        new bootstrap.Modal(orderDetailModalEl).show();
      } catch (err) {
        console.error(err);
        showAlert("Kh√¥ng t·∫£i ƒë∆∞·ª£c chi ti·∫øt h√≥a ƒë∆°n!", "danger");
      }
    }

    btnUpdateStatus.onclick = async () => {
      if (!currentOrderId) return;

      try {
        const res = await fetch(`${API_ORDERS}/${currentOrderId}/status`, {
          method: "PUT",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify({ TrangThai: detailTrangThai.value })
        });

        if (!res.ok) {
          if (res.status === 401) return showAlert("Token h·∫øt h·∫°n / ch∆∞a ƒëƒÉng nh·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!", "warning");
          if (res.status === 403) return showAlert("B·∫°n kh√¥ng c√≥ quy·ªÅn c·∫≠p nh·∫≠t tr·∫°ng th√°i!", "danger");

          const text = await res.text().catch(() => "");
          console.error("Update status error:", res.status, text);
          return showAlert("C·∫≠p nh·∫≠t th·∫•t b·∫°i!", "danger");
        }

        const data = await res.json().catch(() => ({}));
        showAlert(data.message || "C·∫≠p nh·∫≠t th√†nh c√¥ng", "success");
        loadOrders();
      } catch (err) {
        console.error(err);
        showAlert("C·∫≠p nh·∫≠t th·∫•t b·∫°i!", "danger");
      }
    };

    document.getElementById("statusFilter")?.addEventListener("change", () => loadOrders());

    // ch·∫°y
    loadOrders();
  </script>

</body>
</html>
