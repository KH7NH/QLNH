<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <title>Danh s√°ch h√≥a ƒë∆°n (Qu·∫£n l√Ω & B·∫øp)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    .badge { font-size: 0.85rem; padding: 4px 8px; border-radius: 999px; }
    .table-hover tbody tr { cursor: pointer; }
    .detail-items-wrapper { max-height: 300px; overflow-y: auto; }
  </style>
</head>

<body class="py-4">

<!-- üîß FIX: GI·ªÆ DUY NH·∫§T 1 HEADER (X√ìA HEADER TR√ôNG ·ªû D∆Ø·ªöI) -->
<div class="bg-danger text-white mb-3">
  <div class="container d-flex justify-content-between align-items-center py-1">
    <div>
      <i class="bi bi-egg-fried me-1"></i> H·ªá th·ªëng h√≥a ƒë∆°n - Khu√™Food
    </div>
    <div class="d-flex align-items-center gap-2">
      <span id="authInfo" class="small"></span>
      <button id="logoutBtn" class="btn btn-sm btn-light">ƒêƒÉng xu·∫•t</button>
    </div>
  </div>
</div>

<div class="container">

  <div id="alertBox"></div>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0 text-danger">üìÑ DANH S√ÅCH H√ìA ƒê∆†N</h2>

    <select id="statusFilter" class="form-select form-select-sm" style="width:180px">
      <option value="">T·∫•t c·∫£</option>
      <option value="Ch·ªù x·ª≠ l√Ω">Ch·ªù x·ª≠ l√Ω</option>
      <option value="ƒêang l√†m">ƒêang l√†m</option>
      <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
    </select>
  </div>

  <!-- üîß FIX: GI·ªÆ 1 B·∫¢NG DUY NH·∫§T (X√ìA B·∫¢NG TR√ôNG) -->
  <table class="table table-hover align-middle" id="ordersTable">
    <thead class="table-danger">
      <tr>
        <th>ID</th>
        <th>Kh√°ch</th>
        <th>Th·ªùi gian</th>
        <th>Tr·∫°ng th√°i</th>
        <th class="text-end">T·ªïng</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- üîß FIX: GI·ªÆ 1 MODAL DUY NH·∫§T (X√ìA MODAL TR√ôNG) -->
<div class="modal fade" id="orderDetailModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Chi ti·∫øt ƒë∆°n <span id="detailIDDH"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div><strong>Kh√°ch:</strong> <span id="detailTenKhach"></span></div>
        <div><strong>Th·ªùi gian:</strong> <span id="detailThoiGian"></span></div>

        <div><strong>Ghi ch√∫:</strong></div>
        <p id="detailGhiChu" class="text-muted"></p>

        <div class="d-flex justify-content-between align-items-center mb-2">
          <select id="detailTrangThai" class="form-select form-select-sm" style="width:180px">
            <option>Ch·ªù x·ª≠ l√Ω</option>
            <option>ƒêang l√†m</option>
            <option>Ho√†n th√†nh</option>
          </select>

          <button id="btnUpdateStatus" class="btn btn-success btn-sm">
            L∆∞u tr·∫°ng th√°i
          </button>
        </div>

        <div class="detail-items-wrapper">
          <table class="table table-sm table-bordered">
            <thead>
              <tr>
                <th>M√≥n</th>
                <th class="text-end">SL</th>
                <th class="text-end">ƒê∆°n gi√°</th>
                <th class="text-end">Th√†nh ti·ªÅn</th>
              </tr>
            </thead>
            <tbody id="detailItemsBody"></tbody>
          </table>
        </div>

        <div class="text-end mt-2">
          <strong>T·ªïng:</strong> <span id="detailTongTien"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="accessDeniedBox" style="display:none;"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* =====================
   AUTH + ROLE (GI·ªÆ NGUY√äN LOGIC C·ª¶A B·∫†N)
   ===================== */

function normalizeRole(s) {
  return (s || "")
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/\s+/g, "");
}

function getUser() {
  return JSON.parse(localStorage.getItem("user") || "null");
}
function getToken() {
  return localStorage.getItem("token");
}
function authHeaders() {
  return { Authorization: `Bearer ${getToken()}` };
}

// üîß FIX: KH√îNG G·ªåI requireLogin RI√äNG ‚Üí requireRoles ƒê√É BAO H√ÄM
function requireRoles(roles) {
  if (!getUser() || !getToken()) {
    window.location.href = "gdlogin.html";
    return;
  }
  if (!roles.map(normalizeRole).includes(normalizeRole(getUser().VaiTro))) {
    alert("Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p");
    window.location.href = "gdtrangchu.html";
  }
}

// üîß FIX: B·ªé "b·∫øp" d∆∞ ‚Äì normalizeRole ƒë√£ x·ª≠ l√Ω
requireRoles(["Qu·∫£n l√Ω", "Nh√¢n vi√™n", "B·∫øp"]);
</script>

<script>
/* =====================
   ORDER LOGIC ‚Äì FIX NULL/UNDEFINED + MAP FIELD
   ===================== */

const API_ORDERS = "http://localhost:3000/api/order";
let currentOrderId = null;
let currentRole = normalizeRole(getUser()?.VaiTro);

// FIX: khai b√°o element cho ch·∫Øc
const alertBoxEl = document.getElementById("alertBox");

function showAlert(msg, type = "success") {
  if (!alertBoxEl) return;
  alertBoxEl.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
    ${msg}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>`;
}

function pick(obj, keys, fallback = null) {
  for (const k of keys) {
    if (obj && obj[k] !== undefined && obj[k] !== null) return obj[k];
  }
  return fallback;
}

function formatMoney(v) {
  const n = Number(v);
  if (!Number.isFinite(n)) return "0ƒë";
  return n.toLocaleString("vi-VN") + "ƒë";
}

function formatDate(v) {
  if (!v) return "";
  const d = new Date(v);
  if (isNaN(d.getTime())) return "";
  return d.toLocaleString("vi-VN");
}

// MAP c√°c field ph·ªï bi·∫øn (ƒë·ªÉ kh√¥ng b·ªã undefined/Invalid Date)
function normalizeOrderRow(o) {
  const id = pick(o, ["IDDonHang", "IDDH", "IDHD", "id", "_id", "MaDon", "MaHD"], "");
  const tenKhach = pick(o, ["TenKhachHang", "Khach", "customerName", "TenKH"], "");
  const ngay = pick(o, ["Ngay", "ThoiGian", "createdAt", "NgayTao", "NgayLap", "date"], null);
  const trangThai = pick(o, ["TrangThai", "status"], "");
  const tong = pick(o, ["TongTien", "Tong", "total", "ThanhTien"], 0);

  return { id, tenKhach, ngay, trangThai, tong, raw: o };
}

async function loadOrders() {
  try {
    const res = await fetch(API_ORDERS, { headers: authHeaders() });

    if (!res.ok) {
      if (res.status === 401) {
        showAlert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p ho·∫∑c token h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!", "warning");
        // localStorage.clear();
        // window.location.href = "gdlogin.html";
        return;
      }
      if (res.status === 403) {
        showAlert("B·∫°n kh√¥ng c√≥ quy·ªÅn xem danh s√°ch h√≥a ƒë∆°n!", "danger");
        return;
      }
      const text = await res.text().catch(() => "");
      console.error("Load orders error:", res.status, text);
      showAlert("Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch h√≥a ƒë∆°n!", "danger");
      return;
    }

    const data = await res.json();
    renderOrders(Array.isArray(data) ? data : []);
  } catch (err) {
    console.error(err);
    showAlert("Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch h√≥a ƒë∆°n!", "danger");
  }
}

function renderOrders(list) {
  const tbody = document.querySelector("#ordersTable tbody");
  tbody.innerHTML = "";

  // filter theo dropdown tr·∫°ng th√°i
  const filterVal = (document.getElementById("statusFilter")?.value || "").trim();

  const rows = list
    .map(normalizeOrderRow)
    .filter(r => !filterVal || r.trangThai === filterVal);

  if (rows.length === 0) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="5" class="text-center text-muted py-4">Kh√¥ng c√≥ h√≥a ƒë∆°n ph√π h·ª£p.</td>`;
    tbody.appendChild(tr);
    return;
  }

  rows.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.id || ""}</td>
      <td>${r.tenKhach || ""}</td>
      <td>${formatDate(r.ngay) || ""}</td>
      <td>${r.trangThai || ""}</td>
      <td class="text-end">${formatMoney(r.tong)}</td>
    `;
    tr.onclick = () => openOrderDetail(r.id, r.raw);
    tbody.appendChild(tr);
  });
}

// N·∫øu API chi ti·∫øt d√πng id kh√°c (v√≠ d·ª• _id) th√¨ truy·ªÅn c·∫£ raw ƒë·ªÉ fallback
async function openOrderDetail(id, rawRow = null) {
  currentOrderId = id;

  try {
    const res = await fetch(`${API_ORDERS}/${id}`, { headers: authHeaders() });

    if (!res.ok) {
      const text = await res.text().catch(() => "");
      console.error("Order detail error:", res.status, text);
      showAlert("Kh√¥ng t·∫£i ƒë∆∞·ª£c chi ti·∫øt h√≥a ƒë∆°n!", "danger");
      return;
    }

    const o = await res.json();

    // map chi ti·∫øt
    const detailId = pick(o, ["IDDonHang", "IDDH", "IDHD", "id", "_id"], id);
    const tenKhach = pick(o, ["TenKhachHang", "Khach", "customerName", "TenKH"], pick(rawRow, ["TenKhachHang", "Khach"], ""));
    const ngay = pick(o, ["Ngay", "ThoiGian", "createdAt", "NgayTao", "NgayLap"], pick(rawRow, ["Ngay", "ThoiGian", "createdAt"], null));
    const trangThai = pick(o, ["TrangThai", "status"], pick(rawRow, ["TrangThai", "status"], ""));
    const tong = pick(o, ["TongTien", "Tong", "total", "ThanhTien"], pick(rawRow, ["TongTien", "Tong", "total"], 0));
    const ghiChu = pick(o, ["GhiChu", "Note", "GhiCh√∫"], "");

    // items c√≥ th·ªÉ l√† Items ho·∫∑c items ho·∫∑c ChiTiet...
    const items = pick(o, ["Items", "items", "ChiTiet", "orderItems"], []);
    const safeItems = Array.isArray(items) ? items : [];

    detailIDDH.textContent = "#" + (detailId ?? id ?? "");
    detailTenKhach.textContent = tenKhach || "";
    detailThoiGian.textContent = formatDate(ngay) || "";
    detailGhiChu.textContent = ghiChu || "";
    detailTrangThai.value = trangThai || "Ch·ªù x·ª≠ l√Ω";
    detailTongTien.textContent = formatMoney(tong);

    detailItemsBody.innerHTML = "";
    safeItems.forEach(i => {
      const tenMon = pick(i, ["TenMon", "TenMA", "name"], "");
      const soLuong = Number(pick(i, ["SoLuong", "qty", "Quantity"], 0)) || 0;
      const donGia = Number(pick(i, ["DonGia", "Gia", "price"], 0)) || 0;
      const thanhTien = soLuong * donGia;

      detailItemsBody.innerHTML += `
        <tr>
          <td>${tenMon}</td>
          <td class="text-end">${soLuong}</td>
          <td class="text-end">${formatMoney(donGia).replace("ƒë","")}</td>
          <td class="text-end">${formatMoney(thanhTien).replace("ƒë","")}</td>
        </tr>`;
    });

    // UI ph√¢n quy·ªÅn ‚Äì CH·ªà B·∫æP ƒê∆Ø·ª¢C S·ª¨A
    if (currentRole !== "bep") {
      btnUpdateStatus.style.display = "none";
      detailTrangThai.disabled = true;
    } else {
      btnUpdateStatus.style.display = "";
      detailTrangThai.disabled = false;
    }

    new bootstrap.Modal(orderDetailModal).show();
  } catch (err) {
    console.error(err);
    showAlert("Kh√¥ng t·∫£i ƒë∆∞·ª£c chi ti·∫øt h√≥a ƒë∆°n!", "danger");
  }
}

btnUpdateStatus.onclick = async () => {
  try {
    const res = await fetch(`${API_ORDERS}/${currentOrderId}/status`, {
      method: "PUT",
      headers: { "Content-Type": "application/json", ...authHeaders() },
      body: JSON.stringify({ TrangThai: detailTrangThai.value })
    });

    if (!res.ok) {
      const text = await res.text().catch(() => "");
      console.error("Update status error:", res.status, text);
      showAlert("C·∫≠p nh·∫≠t th·∫•t b·∫°i!", "danger");
      return;
    }

    showAlert("C·∫≠p nh·∫≠t th√†nh c√¥ng", "success");
    loadOrders();
  } catch (err) {
    console.error(err);
    showAlert("C·∫≠p nh·∫≠t th·∫•t b·∫°i!", "danger");
  }
};

logoutBtn.onclick = () => {
  localStorage.clear();
  window.location.href = "gdlogin.html";
};

// Filter change
document.getElementById("statusFilter")?.addEventListener("change", () => loadOrders());

loadOrders();
</script>


</body>
</html>
