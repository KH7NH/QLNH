<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <title>Qu·∫£n l√Ω nh√¢n vi√™n</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
</head>

<body class="py-4">

  <!-- üî¥ THANH TR√äN: T√äN TRANG + ƒêƒÇNG XU·∫§T -->
  <div class="bg-danger text-white">
    <div class="container d-flex justify-content-between align-items-center py-1">
      <strong>Qu·∫£n l√Ω nh√¢n vi√™n - Khu√™Food</strong>
      <button id="logoutBtnTop" class="btn btn-sm btn-light">ƒêƒÉng xu·∫•t</button>
    </div>
  </div>

  <div class="container py-4">

    <!-- üîî Th√¥ng b√°o -->
    <div id="alertBox"></div>

    <!-- üö´ Th√¥ng b√°o kh√¥ng ƒë·ªß quy·ªÅn -->
    <div id="accessDeniedBox" style="display:none; margin-bottom:12px;"></div>

    <!-- Header + n√∫t th√™m -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">üìã Danh s√°ch nh√¢n vi√™n</h2>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNhanVien">
        ‚ûï Th√™m nh√¢n vi√™n
      </button>
    </div>

    <!-- B·∫£ng nh√¢n vi√™n -->
    <div class="card shadow-sm">
      <div class="card-body">
        <table class="table table-hover mb-0" id="tblNhanVien">
          <thead class="table-dark">
            <tr>
              <th>STT</th>
              <th>IDNV</th>
              <th>T√™n NV</th>
              <th>Username</th>
              <th>Vai tr√≤</th>
              <th>Password</th>
              <th>H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- MODAL TH√äM / S·ª¨A -->
  <div class="modal fade" id="modalNhanVien" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="nhanVienForm">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">Th√™m nh√¢n vi√™n</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <input type="hidden" id="IDNV">

            <div class="mb-3">
              <label class="form-label">T√™n nh√¢n vi√™n *</label>
              <input type="text" class="form-control" id="TenNV" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Vai tr√≤ *</label>
              <select class="form-control" id="VaiTro" required>
                <option value="">-- Ch·ªçn vai tr√≤ --</option>
                <option value="Nh√¢n vi√™n">Nh√¢n vi√™n</option>
                <option value="Qu·∫£n l√Ω">Qu·∫£n l√Ω</option>
                <option value="B·∫øp">B·∫øp</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Username *</label>
              <input type="text" class="form-control" id="Username" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Password *</label>
              <input type="password" class="form-control" id="PasswordHash" required>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
            <button type="submit" class="btn btn-success">L∆∞u</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ================= AUTH + ROLE GUARD ================= -->
  <script>
    function normalizeRole(s) {
      return (s || "")
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, "");
    }

    function getUser() {
      try { return JSON.parse(localStorage.getItem("user")); }
      catch { return null; }
    }

    function getToken() {
      return localStorage.getItem("token");
    }

    function showAccessDenied(msg) {
      const box = document.getElementById("accessDeniedBox");
      box.style.display = "block";
      box.innerHTML = `
        <div class="alert alert-danger">
          ‚õî ${msg}
        </div>`;
    }

    function requireRoles(roles) {
      const user = getUser();
      const token = getToken();

      if (!user || !token) {
        showAccessDenied("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p.");
        setTimeout(() => location.href = "gdlogin.html", 800);
        return false;
      }

      const role = normalizeRole(user.VaiTro);
      if (!roles.map(normalizeRole).includes(role)) {
        showAccessDenied("Ch·ªâ Qu·∫£n l√Ω m·ªõi ƒë∆∞·ª£c truy c·∫≠p.");
        setTimeout(() => location.href = "gdtrangchu.html", 800);
        return false;
      }

      return true;
    }

    function authHeaders() {
      return { Authorization: `Bearer ${getToken()}` };
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ================= MAIN SCRIPT ================= -->
  <script>
    const API = "http://localhost:3000/api/users/nhanvien";

    function showAlert(msg, type = "success") {
      document.getElementById("alertBox").innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show">
          ${msg}
          <button class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
    }

    // üîß FIX: Ch·ªâ g·ªçi API KHI role h·ª£p l·ªá
    async function loadNhanVien() {
      const res = await fetch(API, { headers: authHeaders() });
      const data = await res.json();

      if (!res.ok) {
        showAlert(data.message || "Kh√¥ng t·∫£i ƒë∆∞·ª£c nh√¢n vi√™n", "danger");
        return;
      }

      // üëâ render table (gi·ªØ nguy√™n logic c≈© c·ªßa b·∫°n)
      console.log("Danh s√°ch NV:", data);
    }

    // üîß FIX: logout d√πng chung cho c·∫£ n√∫t
    function logout() {
      localStorage.removeItem("user");
      localStorage.removeItem("token");
      location.href = "gdlogin.html";
    }

    document.getElementById("logoutBtnTop").addEventListener("click", logout);

    // üîß FIX: Flow chu·∫©n
    document.addEventListener("DOMContentLoaded", () => {
      if (requireRoles(["Qu·∫£n l√Ω"])) {
        loadNhanVien();
      }
    });
  </script>

</body>
</html>
