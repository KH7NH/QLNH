<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qu·∫£n l√Ω nh√¢n vi√™n</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
</head>

<body class="py-4">

  <!-- üî¥ THANH TR√äN -->
  <div class="bg-danger text-white">
    <div class="container d-flex justify-content-between align-items-center py-1">
      <strong>Qu·∫£n l√Ω nh√¢n vi√™n - Khu√™Food</strong>
      <button id="logoutBtnTop" class="btn btn-sm btn-light">ƒêƒÉng xu·∫•t</button>
    </div>
  </div>

  <div class="container py-4">
    <div id="alertBox"></div>
    <div id="accessDeniedBox" style="display:none; margin-bottom:12px;"></div>

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">üìã Danh s√°ch nh√¢n vi√™n</h2>
      <button id="btnOpenCreate" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNhanVien">
        ‚ûï Th√™m nh√¢n vi√™n
      </button>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <table class="table table-hover mb-0" id="tblNhanVien">
          <thead class="table-dark">
            <tr>
              <th>STT</th>
              <th>IDNV</th>
              <th>T√™n NV</th>
              <th>Username</th>
              <th>Vai tr√≤</th>
              <th>Password</th>
              <th style="width:120px;">H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- MODAL TH√äM / S·ª¨A -->
  <div class="modal fade" id="modalNhanVien" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="nhanVienForm">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">Th√™m nh√¢n vi√™n</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <input type="hidden" id="IDNV">

            <div class="mb-3">
              <label class="form-label">T√™n nh√¢n vi√™n *</label>
              <input type="text" class="form-control" id="TenNV" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Vai tr√≤ *</label>
              <select class="form-control" id="VaiTro" required>
                <option value="">-- Ch·ªçn vai tr√≤ --</option>
                <option value="Nh√¢n vi√™n">Nh√¢n vi√™n</option>
                <option value="Qu·∫£n l√Ω">Qu·∫£n l√Ω</option>
                <option value="B·∫øp">B·∫øp</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Username *</label>
              <input type="text" class="form-control" id="Username" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Password *</label>
              <input type="password" class="form-control" id="PasswordHash" required>
              <div class="form-text" id="pwHelp">
                Kh√¥ng n√™n ƒë·ªÉ tr·ªëng khi th√™m m·ªõi. Khi s·ª≠a: ƒë·ªÉ tr·ªëng n·∫øu mu·ªën gi·ªØ password c≈©.
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
            <button id="btnSave" type="submit" class="btn btn-success">L∆∞u</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- AUTH + HELPERS -->
  <script>
    function normalizeRole(s) {
      return (s || "")
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, "");
    }

    function getUser() {
      try { return JSON.parse(localStorage.getItem("user")); }
      catch { return null; }
    }

    function getToken() {
      return localStorage.getItem("token");
    }

    function showAccessDenied(msg) {
      const box = document.getElementById("accessDeniedBox");
      box.style.display = "block";
      box.innerHTML = `<div class="alert alert-danger mb-0">‚õî ${msg}</div>`;
    }

    function requireRoles(roles) {
      const user = getUser();
      const token = getToken();

      if (!user || !token) {
        showAccessDenied("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p.");
        setTimeout(() => location.href = "gdlogin.html", 800);
        return false;
      }

      const role = normalizeRole(user.VaiTro);
      if (!roles.map(normalizeRole).includes(role)) {
        showAccessDenied("Ch·ªâ Qu·∫£n l√Ω m·ªõi ƒë∆∞·ª£c truy c·∫≠p.");
        setTimeout(() => location.href = "gdtrangchu.html", 800);
        return false;
      }
      return true;
    }

    function authHeaders() {
      return {
        "Authorization": `Bearer ${getToken()}`,
        "Content-Type": "application/json"
      };
    }

    function logout() {
      localStorage.removeItem("user");
      localStorage.removeItem("token");
      location.href = "gdlogin.html";
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function showAlert(msg, type = "success") {
      document.getElementById("alertBox").innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show">
          ${msg}
          <button class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- MAIN CRUD -->
  <script>
    const API = "http://localhost:3000/api/users/nhanvien";

    const modalEl = document.getElementById("modalNhanVien");
    const modal = new bootstrap.Modal(modalEl);

    const form = document.getElementById("nhanVienForm");
    const modalTitle = document.getElementById("modalTitle");
    const btnSave = document.getElementById("btnSave");

    const fIDNV = document.getElementById("IDNV");
    const fTenNV = document.getElementById("TenNV");
    const fVaiTro = document.getElementById("VaiTro");
    const fUsername = document.getElementById("Username");
    const fPassword = document.getElementById("PasswordHash");
    const pwHelp = document.getElementById("pwHelp");

    let cacheNhanVien = []; // d√πng ƒë·ªÉ fill khi edit

    function setLoadingTable(msg = "ƒêang t·∫£i...") {
      document.querySelector("#tblNhanVien tbody").innerHTML =
        `<tr><td colspan="7" class="text-center text-muted">${escapeHtml(msg)}</td></tr>`;
    }

    async function safeJson(res) {
      const ct = res.headers.get("content-type") || "";
      if (ct.includes("application/json")) return await res.json();
      return await res.text();
    }

    async function loadNhanVien() {
      setLoadingTable("ƒêang t·∫£i...");
      let res;

      try {
        res = await fetch(API, { headers: authHeaders() });
      } catch {
        setLoadingTable("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server");
        showAlert("Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server!", "danger");
        return;
      }

      const payload = await safeJson(res);

      if (res.status === 401) {
        showAlert("Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.", "warning");
        setTimeout(logout, 800);
        return;
      }
      if (res.status === 403) {
        const msg = (typeof payload === "string") ? payload : (payload.message || "Kh√¥ng ƒë·ªß quy·ªÅn truy c·∫≠p");
        showAccessDenied(msg);
        setLoadingTable("‚õî " + msg);
        return;
      }
      if (!res.ok) {
        const msg = (typeof payload === "string") ? payload : (payload.message || "Kh√¥ng t·∫£i ƒë∆∞·ª£c nh√¢n vi√™n");
        setLoadingTable(msg);
        showAlert(msg, "danger");
        return;
      }

      const data = payload;
      cacheNhanVien = Array.isArray(data) ? data : [];

      renderTable(cacheNhanVien);
    }

    function renderTable(list) {
      const tbody = document.querySelector("#tblNhanVien tbody");

      if (!list.length) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Ch∆∞a c√≥ nh√¢n vi√™n</td></tr>`;
        return;
      }

      tbody.innerHTML = list.map((nv, idx) => `
        <tr>
          <td>${idx + 1}</td>
          <td>${escapeHtml(nv.IDNV)}</td>
          <td>${escapeHtml(nv.TenNV)}</td>
          <td>${escapeHtml(nv.Username)}</td>
          <td>${escapeHtml(nv.VaiTro)}</td>
          <td>${escapeHtml(nv.PasswordHash)}</td>
          <td>
            <button class="btn btn-sm btn-warning me-1" onclick="openEdit(${nv.IDNV})" title="S·ª≠a">
              <i class="bi bi-pencil-square"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteNhanVien(${nv.IDNV})" title="X√≥a">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `).join("");
    }

    // ===== OPEN CREATE =====
    function openCreate() {
      modalTitle.textContent = "Th√™m nh√¢n vi√™n";
      btnSave.textContent = "L∆∞u";

      fIDNV.value = "";
      fTenNV.value = "";
      fVaiTro.value = "";
      fUsername.value = "";
      fPassword.value = "";
      fPassword.required = true;
      pwHelp.classList.remove("text-muted");
      pwHelp.innerHTML = "Khi th√™m: b·∫Øt bu·ªôc nh·∫≠p password.";

      modal.show();
    }

    // ===== OPEN EDIT =====
    window.openEdit = function (id) {
      const nv = cacheNhanVien.find(x => String(x.IDNV) === String(id));
      if (!nv) {
        showAlert("Kh√¥ng t√¨m th·∫•y nh√¢n vi√™n ƒë·ªÉ s·ª≠a", "danger");
        return;
      }

      modalTitle.textContent = "S·ª≠a nh√¢n vi√™n";
      btnSave.textContent = "C·∫≠p nh·∫≠t";

      fIDNV.value = nv.IDNV;
      fTenNV.value = nv.TenNV || "";
      fVaiTro.value = nv.VaiTro || "";
      fUsername.value = nv.Username || "";

      // Khi s·ª≠a: cho ph√©p tr·ªëng (ƒë·ªÉ gi·ªØ password)
      fPassword.value = "";
      fPassword.required = false;
      pwHelp.classList.add("text-muted");

      modal.show();
    }

    // ===== SUBMIT CREATE/UPDATE =====
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const id = fIDNV.value.trim();
      const payload = {
        TenNV: fTenNV.value.trim(),
        VaiTro: fVaiTro.value,
        Username: fUsername.value.trim(),
        PasswordHash: fPassword.value // c√≥ th·ªÉ "" khi s·ª≠a (tu·ª≥ backend)
      };

      // validate basic
      if (!payload.TenNV || !payload.VaiTro || !payload.Username) {
        showAlert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß TenNV, VaiTro, Username", "danger");
        return;
      }
      if (!id && !payload.PasswordHash) {
        showAlert("Khi th√™m m·ªõi: Password l√† b·∫Øt bu·ªôc", "danger");
        return;
      }

      // N·∫øu ƒëang s·ª≠a v√† password tr·ªëng: KH√îNG g·ª≠i PasswordHash (ƒë·ªÉ gi·ªØ nguy√™n)
      // (Backend hi·ªán t·∫°i c·ªßa b·∫°n update lu√¥n PasswordHash => g·ª≠i tr·ªëng s·∫Ω set tr·ªëng)
      if (id && !payload.PasswordHash) {
        delete payload.PasswordHash;
      }

      btnSave.disabled = true;
      btnSave.textContent = "ƒêang l∆∞u...";

      try {
        const url = id ? `${API}/${encodeURIComponent(id)}` : API;
        const method = id ? "PUT" : "POST";

        const res = await fetch(url, {
          method,
          headers: authHeaders(),
          body: JSON.stringify(payload)
        });

        const data = await safeJson(res);

        if (res.status === 401) {
          showAlert("Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.", "warning");
          setTimeout(logout, 800);
          return;
        }
        if (!res.ok) {
          const msg = (typeof data === "string") ? data : (data.message || "Thao t√°c th·∫•t b·∫°i");
          showAlert(msg, "danger");
          return;
        }

        showAlert(id ? "‚úÖ C·∫≠p nh·∫≠t nh√¢n vi√™n th√†nh c√¥ng!" : "‚úÖ Th√™m nh√¢n vi√™n th√†nh c√¥ng!", "success");
        modal.hide();
        await loadNhanVien();

      } catch (err) {
        console.error(err);
        showAlert("Kh√¥ng th·ªÉ k·∫øt n·ªëi server khi l∆∞u!", "danger");
      } finally {
        btnSave.disabled = false;
        btnSave.textContent = id ? "C·∫≠p nh·∫≠t" : "L∆∞u";
      }
    });

    // ===== DELETE =====
    window.deleteNhanVien = async function (id) {
      const nv = cacheNhanVien.find(x => String(x.IDNV) === String(id));
      const name = nv ? `${nv.TenNV} (${nv.Username})` : `IDNV ${id}`;

      if (!confirm(`B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a: ${name} ?`)) return;

      try {
        const res = await fetch(`${API}/${encodeURIComponent(id)}`, {
          method: "DELETE",
          headers: authHeaders()
        });

        const data = await safeJson(res);

        if (res.status === 401) {
          showAlert("Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.", "warning");
          setTimeout(logout, 800);
          return;
        }

        if (!res.ok) {
          const msg = (typeof data === "string") ? data : (data.message || "X√≥a th·∫•t b·∫°i");
          showAlert(msg, "danger");
          return;
        }

        showAlert("‚úÖ X√≥a nh√¢n vi√™n th√†nh c√¥ng!", "success");
        await loadNhanVien();
      } catch (err) {
        console.error(err);
        showAlert("Kh√¥ng th·ªÉ k·∫øt n·ªëi server khi x√≥a!", "danger");
      }
    }

    // ===== INIT =====
    document.getElementById("logoutBtnTop").addEventListener("click", logout);
    document.getElementById("btnOpenCreate").addEventListener("click", openCreate);

    document.addEventListener("DOMContentLoaded", () => {
      if (requireRoles(["Qu·∫£n l√Ω"])) loadNhanVien();
    });
  </script>

</body>

</html>
