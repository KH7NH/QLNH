<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gi·ªè h√†ng c·ªßa b·∫°n</title>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  <style>
    body {
      background-color: #fafafa;
      font-family: Arial, sans-serif;
    }

    .cart-item {
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid #ddd;
      padding: 10px 0;
    }

    .cart-item img {
      width: 70px;
      height: 70px;
      border-radius: 8px;
      object-fit: cover;
    }

    .cart-item .info {
      flex: 1;
    }

    .cart-item .remove-btn {
      cursor: pointer;
      color: red;
      font-size: 18px;
    }

    .summary-box {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>

<body class="p-4">
  <!-- TOP BAR -->
  <div class="bg-danger d-flex flex-row mb-3 align-items-center justify-content-between" style="padding: 5px 20px;">
    <div class="d-flex flex-row">
      <a style="color:#ccc;">1900 6750</a>
      <a style="color:#ccc; margin-left:20px;">Th·ª© 2 - Ch·ªß Nh·∫≠t 9:00 - 18:00</a>

      <a href="gdtrangchu.html" style="color:white; margin-left:100px;">Trang ch·ªß</a>
      <a href="thucdon.html" style="color:white; margin-left:40px;">Th·ª±c ƒë∆°n</a>
    </div>

    <div id="authArea" class="d-flex align-items-center">
      <div id="guestArea">
        <a href="gdlogin.html" style="color:#fff; margin-right:15px;">ƒêƒÉng nh·∫≠p</a>
        <a href="gdsignup.html" style="color:#fff;">ƒêƒÉng k√Ω</a>
      </div>

      <div id="userArea" style="display:none;">
        <span id="welcomeText" style="color:#fff; margin-right:15px;"></span>
        <button id="logoutBtn" class="btn btn-sm btn-light">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>
  </div>

  <div class="container">
    <h2 class="text-center text-primary mb-4">üõí Gi·ªè h√†ng c·ªßa b·∫°n</h2>

    <div class="row">
      <!-- FORM -->
      <div class="col-md-4 mb-4">
        <h5 class="text-success">Th√¥ng tin ƒë∆°n h√†ng</h5>
        <form id="shippingForm">
          <div class="form-group">
            <label>H·ªç v√† t√™n</label>
            <input type="text" id="customerName" class="form-control">
          </div>
          <div class="form-group">
            <label>Ghi ch√∫</label>
            <textarea id="note" class="form-control"></textarea>
          </div>
        </form>
      </div>

      <!-- CART -->
      <div class="col-md-5 mb-4">
        <h5 class="text-info">S·∫£n ph·∫©m ƒë√£ th√™m</h5>
        <div id="cartList" class="bg-white p-3 rounded shadow-sm"></div>
        <div class="text-right mt-2">
          <button class="btn btn-danger btn-sm" onclick="clearCart()">üóëÔ∏è X√≥a to√†n b·ªô</button>
        </div>
      </div>

      <!-- SUMMARY -->
      <div class="col-md-3">
        <div class="summary-box">
          <h5>T√≥m t·∫Øt ƒë∆°n h√†ng</h5>
          <div class="d-flex justify-content-between">
            <span>T·∫°m t√≠nh:</span>
            <span id="subtotal">0ƒë</span>
          </div>
          <hr>
          <div class="d-flex justify-content-between font-weight-bold">
            <span>T·ªïng c·ªông:</span>
            <span id="total">0ƒë</span>
          </div>
          <hr>
          <button id="btnDatHang" class="btn btn-primary w-100">ƒê·∫∑t h√†ng</button>
          <a href="thucdon.html" class="btn btn-link d-block text-center">‚Üê Quay l·∫°i</a>
        </div>
      </div>
    </div>
  </div>

  <!-- CART SCRIPT -->
  <script>
    const CART_KEY = "cartItems";

    function getCart() {
      try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; }
      catch { return []; }
    }

    function saveCart(cart) {
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
    }

    function removeItem(name) {
      // üîß FIX: escape d·∫•u ' trong t√™n m√≥n ƒë·ªÉ tr√°nh l·ªói JS
      const cart = getCart().filter(i => i.name !== name);
      saveCart(cart);
      renderCart();
    }

    function clearCart() {
      localStorage.removeItem(CART_KEY);
      renderCart();
    }

    function renderCart() {
      const cart = getCart();
      const box = document.getElementById("cartList");

      if (!cart.length) {
        box.innerHTML = "<p>üõçÔ∏è Gi·ªè h√†ng tr·ªëng</p>";
        document.getElementById("subtotal").textContent = "0ƒë";
        document.getElementById("total").textContent = "0ƒë";
        return;
      }

      let total = 0;
      box.innerHTML = cart.map(i => {
        total += i.price * i.qty;
        return `
          <div class="cart-item">
            <img src="${i.img}">
            <div class="info">
              <strong>${i.name}</strong><br>
              <small>${i.price.toLocaleString("vi-VN")}ƒë √ó ${i.qty}</small>
            </div>
            <span class="remove-btn" onclick="removeItem('${i.name.replace(/'/g, "\\'")}')">
              <i class="bi bi-trash"></i>
            </span>
          </div>
        `;
      }).join("");

      document.getElementById("subtotal").textContent = total.toLocaleString("vi-VN") + "ƒë";
      document.getElementById("total").textContent = total.toLocaleString("vi-VN") + "ƒë";
    }

    document.addEventListener("DOMContentLoaded", renderCart);
  </script>

  <!-- ORDER SCRIPT -->
  <script>
    document.getElementById("btnDatHang").addEventListener("click", async () => {
      const user = JSON.parse(localStorage.getItem("user") || "null");
      const token = localStorage.getItem("token"); // üîß FIX: c·∫ßn token khi g·ªçi backend
      const cart = getCart();

      // üîß FIX: chu·∫©n h√≥a vai tr√≤ (tr√°nh sai d·∫•u)
      const role = (user?.VaiTro || "").toLowerCase();

      if (!user || (role !== "nh√¢n vi√™n" && role !== "qu·∫£n l√Ω")) {
        alert("Ch·ªâ Nh√¢n vi√™n v√† Qu·∫£n l√Ω ƒë∆∞·ª£c ƒë·∫∑t h√†ng");
        window.location.href = "gdlogin.html";
        return;
      }

      if (!cart.length) {
        alert("Gi·ªè h√†ng tr·ªëng");
        return;
      }

      const TenKhachHang = document.getElementById("customerName").value.trim();
      if (!TenKhachHang) {
        alert("Vui l√≤ng nh·∫≠p t√™n kh√°ch");
        return;
      }

      const orderData = {
        IDNV: user.IDNV,
        TenKhachHang,
        GhiChu: document.getElementById("note").value.trim(),
        ChiTiet: cart.map(i => ({
          IDMA: i.id,
          SoLuong: i.qty,
          DonGia: i.price
        }))
      };
      console.log("orderData g·ª≠i l√™n:", orderData);
      console.log("ChiTiet:", orderData.ChiTiet);
      try {
        const res = await fetch("http://localhost:3000/api/order/create", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token // üîß FIX: thi·∫øu Authorization
          },
          body: JSON.stringify(orderData)
        });

        if (!res.ok) throw new Error("API error");

        alert("‚úÖ ƒê·∫∑t h√†ng th√†nh c√¥ng");
        clearCart();
        document.getElementById("shippingForm").reset();
      } catch (e) {
        alert("‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi server");
        console.error(e);
      }
    });
  </script>

  <!-- AUTH SCRIPT -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const user = JSON.parse(localStorage.getItem("user") || "null");

      if (!user) {
        alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p");
        window.location.href = "gdlogin.html";
        return;
      }

      document.getElementById("guestArea").style.display = "none";
      document.getElementById("userArea").style.display = "flex";
      document.getElementById("welcomeText").textContent =
        `Xin ch√†o, ${user.TenNV || user.Username}`;

      document.getElementById("logoutBtn").onclick = () => {
        localStorage.clear();
        window.location.href = "gdlogin.html";
      };
    });
  </script>
</body>

</html>