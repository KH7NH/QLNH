<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gi·ªè h√†ng c·ªßa b·∫°n</title>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  <style>
    body {
      background-color: #fafafa;
      font-family: Arial, sans-serif;
    }

    .cart-item {
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid #ddd;
      padding: 10px 0;
    }

    .cart-item img {
      width: 70px;
      height: 70px;
      border-radius: 8px;
      object-fit: cover;
    }

    .cart-item .info {
      flex: 1;
    }

    .cart-item .remove-btn {
      cursor: pointer;
      color: red;
      font-size: 18px;
    }

    .summary-box {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>

<body class="p-4">
  <!-- TOP BAR -->
  <div class="bg-danger d-flex flex-row mb-3 align-items-center justify-content-between" style="padding: 5px 20px;">
    <div class="d-flex flex-row">
      <a style="color:#ccc;">1900 6750</a>
      <a style="color:#ccc; margin-left:20px;">Th·ª© 2 - Ch·ªß Nh·∫≠t 9:00 - 18:00</a>

      <a href="gdtrangchu.html" style="color:white; margin-left:100px;">Trang ch·ªß</a>
      <a href="thucdon.html" style="color:white; margin-left:40px;">Th·ª±c ƒë∆°n</a>
    </div>

    <div id="authArea" class="d-flex align-items-center">
      <div id="guestArea">
        <a href="gdlogin.html" style="color:#fff; margin-right:15px;">ƒêƒÉng nh·∫≠p</a>
        <a href="gdsignup.html" style="color:#fff;">ƒêƒÉng k√Ω</a>
      </div>

      <div id="userArea" style="display:none;">
        <span id="welcomeText" style="color:#fff; margin-right:15px;"></span>
        <button id="logoutBtn" class="btn btn-sm btn-light">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>
  </div>

  <div class="container">
    <h2 class="text-center text-primary mb-4">üõí Gi·ªè h√†ng c·ªßa b·∫°n</h2>

    <div class="row">
      <!-- FORM -->
      <div class="col-md-4 mb-4">
        <h5 class="text-success">Th√¥ng tin ƒë∆°n h√†ng</h5>
        <form id="shippingForm">
          <div class="form-group">
            <label>H·ªç v√† t√™n</label>
            <input type="text" id="customerName" class="form-control">
          </div>
          <div class="form-group">
            <label>Ghi ch√∫</label>
            <textarea id="note" class="form-control"></textarea>
          </div>
        </form>
      </div>

      <!-- CART -->
      <div class="col-md-5 mb-4">
        <h5 class="text-info">S·∫£n ph·∫©m ƒë√£ th√™m</h5>
        <div id="cartList" class="bg-white p-3 rounded shadow-sm"></div>
        <div class="text-right mt-2">
          <button class="btn btn-danger btn-sm" id="btnClearCart">üóëÔ∏è X√≥a to√†n b·ªô</button>
        </div>
      </div>

      <!-- SUMMARY -->
      <div class="col-md-3">
        <div class="summary-box">
          <h5>T√≥m t·∫Øt ƒë∆°n h√†ng</h5>
          <div class="d-flex justify-content-between">
            <span>T·∫°m t√≠nh:</span>
            <span id="subtotal">0ƒë</span>
          </div>
          <hr>
          <div class="d-flex justify-content-between font-weight-bold">
            <span>T·ªïng c·ªông:</span>
            <span id="total">0ƒë</span>
          </div>
          <hr>
          <button id="btnDatHang" class="btn btn-primary w-100">ƒê·∫∑t h√†ng</button>
          <a href="thucdon.html" class="btn btn-link d-block text-center">‚Üê Quay l·∫°i</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    const CART_KEY = "cartItems";
    const API_CREATE_ORDER = "http://localhost:3000/api/order";

    function normalizeRole(s) {
      return (s || "")
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, "");
    }

    function getUser() {
      try { return JSON.parse(localStorage.getItem("user") || "null"); }
      catch { return null; }
    }

    function getToken() {
      return localStorage.getItem("token");
    }

    function getCart() {
      try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; }
      catch { return []; }
    }

    function saveCart(cart) {
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
    }

    function removeItem(name) {
      const cart = getCart().filter(i => i.name !== name);
      saveCart(cart);
      renderCart();
    }

    function clearCart() {
      localStorage.removeItem(CART_KEY);
      renderCart();
    }

    function renderCart() {
      const cart = getCart();
      const box = document.getElementById("cartList");

      if (!cart.length) {
        box.innerHTML = "<p>üõçÔ∏è Gi·ªè h√†ng tr·ªëng</p>";
        document.getElementById("subtotal").textContent = "0ƒë";
        document.getElementById("total").textContent = "0ƒë";
        return;
      }

      let total = 0;
      box.innerHTML = cart.map(i => {
        total += (Number(i.price) || 0) * (Number(i.qty) || 0);
        const safeName = String(i.name || "").replace(/'/g, "\\'");
        return `
          <div class="cart-item">
            <img src="${i.img || ""}">
            <div class="info">
              <strong>${i.name || ""}</strong><br>
              <small>${(Number(i.price) || 0).toLocaleString("vi-VN")}ƒë √ó ${i.qty || 0}</small>
            </div>
            <span class="remove-btn" onclick="removeItem('${safeName}')">
              <i class="bi bi-trash"></i>
            </span>
          </div>
        `;
      }).join("");

      document.getElementById("subtotal").textContent = total.toLocaleString("vi-VN") + "ƒë";
      document.getElementById("total").textContent = total.toLocaleString("vi-VN") + "ƒë";
    }

    async function safeReadJson(res) {
      try { return await res.json(); } catch { return null; }
    }

    document.addEventListener("DOMContentLoaded", () => {
      // AUTH UI
      const user = getUser();
      if (!user || !getToken()) {
        alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p");
        window.location.href = "gdlogin.html";
        return;
      }

      document.getElementById("guestArea").style.display = "none";
      document.getElementById("userArea").style.display = "flex";
      document.getElementById("welcomeText").textContent =
        `Xin ch√†o, ${user.TenNV || user.Username || ""}`;

      document.getElementById("logoutBtn").onclick = () => {
        localStorage.clear();
        window.location.href = "gdlogin.html";
      };

      // CART
      renderCart();
      document.getElementById("btnClearCart").addEventListener("click", clearCart);

      // ORDER
      document.getElementById("btnDatHang").addEventListener("click", async () => {
        const user = getUser();
        const token = getToken();
        const cart = getCart();

        if (!user || !token) {
          alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p ho·∫∑c token h·∫øt h·∫°n");
          window.location.href = "gdlogin.html";
          return;
        }

        const role = normalizeRole(user?.VaiTro);
        if (role !== "nhanvien" && role !== "quanly") {
          alert("Ch·ªâ Nh√¢n vi√™n v√† Qu·∫£n l√Ω ƒë∆∞·ª£c ƒë·∫∑t h√†ng");
          return;
        }

        if (!cart.length) {
          alert("Gi·ªè h√†ng tr·ªëng");
          return;
        }

        const TenKhachHang = document.getElementById("customerName").value.trim();
        if (!TenKhachHang) {
          alert("Vui l√≤ng nh·∫≠p t√™n kh√°ch");
          return;
        }

        const orderData = {
          IDNV: user.IDNV,
          TenKhachHang,
          GhiChu: document.getElementById("note").value.trim(),
          ChiTiet: cart.map(i => ({
            IDMA: i.id,
            SoLuong: i.qty
            // DonGia kh√¥ng b·∫Øt bu·ªôc v√¨ backend t√≠nh t·ª´ DB (JOIN MonAn)
          }))
        };

        try {
          const res = await fetch(API_CREATE_ORDER, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + token
            },
            body: JSON.stringify(orderData)
          });

          const data = await safeReadJson(res);

          if (!res.ok) {
            console.error("Create order failed:", res.status, data);
            if (res.status === 401) {
              alert("Token kh√¥ng h·ª£p l·ªá / h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
              localStorage.clear();
              window.location.href = "gdlogin.html";
              return;
            }
            alert(data?.message || `‚ùå T·∫°o ƒë∆°n th·∫•t b·∫°i (HTTP ${res.status})`);
            return;
          }

          alert("‚úÖ ƒê·∫∑t h√†ng th√†nh c√¥ng");
          clearCart();
          document.getElementById("shippingForm").reset();

        } catch (e) {
          console.error(e);
          alert("‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi server");
        }
      });
    });
  </script>
</body>

</html>
